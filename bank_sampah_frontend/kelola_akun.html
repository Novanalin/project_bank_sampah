<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Akun - Bank Sampah</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-container" id="logo-container">
            <div class="logo-wrapper">
                <img src="./img/logo_bank_sampah.jpeg" alt="Logo Bank Sampah" class="logo">
            </div>
            <div class="app-title">Bank Sampah</div>
        </div>
        
        <ul class="menu">
            <li class="menu-section">Transaksi</li>
            <li><a href="transaksi_input.html" class="menu-item"><i class="fas fa-sign-in-alt"></i> <span>Transaksi Input</span></a></li>
            <li><a href="transaksi_output.html" class="menu-item"><i class="fas fa-sign-out-alt"></i> <span>Transaksi Output</span></a></li>
            
            <li class="menu-section">Kelola Data</li>
            <li><a href="#" class="menu-item active"><i class="fas fa-users"></i> <span>Kelola Akun</span></a></li>
            <li><a href="kelola_pengepul.html" class="menu-item"><i class="fas fa-truck"></i> <span>Kelola Pengepul</span></a></li>
            <li><a href="kelola_jenis_sampah.html" class="menu-item"><i class="fas fa-cog"></i> <span>Kelola Jenis Sampah</span></a></li>
            
            <li class="menu-section">Laporan</li>
            <li class="has-submenu">
                <a href="#" class="menu-item" id="laporan-menu">
                    <i class="fas fa-chart-bar"></i> 
                    <span>Laporan</span>
                    <i class="fas fa-chevron-down dropdown-icon"></i>
                </a>
                <ul class="submenu" id="laporan-submenu">
                    <li><a href="laporan_transaksi.html" class="menu-item"><i class="fas fa-file-invoice-dollar"></i> <span>Laporan Transaksi</span></a></li>
                    <li><a href="laporan_stok.html" class="menu-item"><i class="fas fa-boxes"></i> <span>Laporan Stok</span></a></li>
                </ul>
            </li>
            
            <li class="menu-section">Akun</li>
            <li><a href="#" class="menu-item" id="logout"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <h1 class="page-title">Kelola Akun</h1>
            <div class="user-info">
                <div class="user-avatar">AD</div>
                <div class="user-text">
                    <div class="user-greeting" id="user">Hi</div>
                    <div class="user-role">Administrator</div>
                </div>
            </div>
        </div>
        
        <!-- Content Container -->
        <div class="content-container">
            <!-- Search and Filter Section -->
            <div class="search-filter-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Cari nama atau ID customer...">
                </div>
                
                <div class="filter-container">
                    <select class="filter-select" id="status-filter">
                        <option value="">Semua Status</option>
                        <option value="aktif">Aktif</option>
                        <option value="nonaktif">Non Aktif</option>
                    </select>
                    
                    <select class="filter-select" id="kategori-filter">
                        <option value="">Semua Kategori</option>
                        <option value="siswa">Siswa</option>
                        <option value="guru">Guru</option>
                    </select>
                    
                    <button class="btn-add" id="btn-add-user">
                        <i class="fas fa-plus"></i> Tambah Akun
                    </button>
                </div>
            </div>
            
            <!-- Table Container -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>ID Customer</th>
                            <th>Name Customer</th>
                            <th>Kategori</th>
                            <th>Kelas</th>
                            <th>Status</th>
                            <th>ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-container">
                <div class="pagination-info" id="pagination-info">
                    Menampilkan 1 sampai 4 dari 4 data
                </div>
                
                <div class="pagination" id="pagination">
                    <!-- Pagination buttons will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit User -->
    <div class="modal" id="user-modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modal-title">Tambah Akun Baru</h2>
            
            <form id="user-form">
                <div style="margin-bottom: 15px;">
                    <label class="modal-label">ID Customer</label>
                    <input type="text" id="modal-id" class="modal-input" disabled>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label class="modal-label">Nama Customer</label>
                    <input type="text" id="modal-nama" class="modal-input" required>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label class="modal-label">Kategori</label>
                    <select id="modal-kategori" class="modal-input" required>
                        <option value="">Pilih Kategori</option>
                        <option value="Siswa">Siswa</option>
                        <option value="Guru">Guru</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label class="modal-label">Kelas</label>
                    <input type="text" id="modal-kelas" class="modal-input">
                    <small style="color: #6c757d; font-size: 12px;">Isi "N/A" untuk guru</small>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label class="modal-label">Status</label>
                    <select id="modal-status" class="modal-input" required>
                        <option value="Aktif">Aktif</option>
                        <option value="Nonaktif">Nonaktif</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" id="btn-cancel" class="modal-btn modal-btn-cancel">Batal</button>
                    <button type="submit" id="btn-save" class="modal-btn modal-btn-save">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Overlay untuk modal (DI BAWAH MODAL) -->
    <div class="modal-overlay" id="modal-overlay"></div>
    
    <!-- Modal Konfirmasi Logout (DI ATAS OVERLAY) -->
    <div class="logout-modal" id="logout-modal">
        <div class="modal-icon">
            <img src="./img/icon_logout.png" width="100" height="100">
        </div>
        <p class="modal-message">Apakah Anda yakin ingin keluar?</p>
        <div class="modal-buttons">
            <button class="modal-btn-logout cancel" id="cancel-logout">Tidak</button>
            <button class="modal-btn-logout confirm" id="confirm-logout">Ya</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const logoContainer = document.getElementById('logo-container');
        const menuItems = document.querySelectorAll('.menu-item');
        const laporanMenu = document.getElementById('laporan-menu');
        const laporanSubmenu = document.getElementById('laporan-submenu');
        const hasSubmenu = laporanMenu ? laporanMenu.closest('.has-submenu') : null;
        const logoutContainer = document.getElementById('logout');
        const logoutModal = document.getElementById('logout-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const cancelLogoutBtn = document.getElementById('cancel-logout');
        const confirmLogoutBtn = document.getElementById('confirm-logout');
        const userTableBody = document.getElementById('user-table-body');
        const paginationInfo = document.getElementById('pagination-info');
        const paginationContainer = document.getElementById('pagination');
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        const kategoriFilter = document.getElementById('kategori-filter');
        const btnAddUser = document.getElementById('btn-add-user');
        const userModal = document.getElementById('user-modal');
        const modalTitle = document.getElementById('modal-title');
        const userForm = document.getElementById('user-form');
        const btnCancel = document.getElementById('btn-cancel');
        const btnSave = document.getElementById('btn-save');

        // State
        let isLogin = false;
        let storedLoginData;
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentEditId = null;
        let users = [];


        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginData();

            if (isLogin) {
                // Fetch data from server when page loads
                fetchData();
                
                // Setup event listeners
                setupEventListeners();
            }
        });

        function checkLoginData() {
            // Retrieve the value using the same key 'loginData'
            storedLoginData = JSON.parse(localStorage.getItem('loginData'));

            if (storedLoginData == null) {
                window.location.replace('./login.html');
            } else {
                isLogin = true;
                document.getElementById("user").textContent = `Hi, ${storedLoginData.nama}`;
            }
        }

        async function fetchData() {
            try {
                const response = await fetch('http://localhost:3000/customer');
                console.log('response', response);

				const result = await response.json();
				console.log('result', result);

                users = result.data || [];
                console.log('data', users);

                renderTable();
            } catch (error) {
                console.error('Error during fetch data:', error);
        		alert('An error occurred. Please try again later.');
            }
        }
  
        // Filter users based on search and filters
        function getFilteredUsers() {
            // let filtered = [...users];
            
            // Apply search filter
            const searchTerm = searchInput.value.toLowerCase();
            // if (searchTerm) {
            //     filtered = filtered.filter(user => 
            //         user.nama.toLowerCase().includes(searchTerm) || 
            //         user.customerID.toLowerCase().includes(searchTerm)
            //     );
            // }
            
            // Apply status filter
            const statusFilterValue = statusFilter.value.toLowerCase();
            // if (statusFilterValue) {
            //     filtered = filtered.filter(user => 
            //         user.status.toLowerCase() === statusFilterValue
            //     );
            // }
            
            // Apply kategori filter
            const kategoriFilterValue = kategoriFilter.value.toLowerCase();
            // if (kategoriFilterValue) {
            //     filtered = filtered.filter(user => 
            //         user.kategori.toLowerCase() === kategoriFilterValue
            //     );
            // }
            
            // return filtered;


            return users.filter(user => {
                const matchesSearch = user.nama.toLowerCase().includes(searchTerm) || 
                              String(user.customerID).includes(searchTerm);
                const matchesStatus = statusFilterValue === "" || user.status.toLowerCase() === statusFilterValue;
                const matchesKategori = kategoriFilterValue === "" || user.kategori.toLowerCase() === kategoriFilterValue;
        
                return matchesSearch && matchesStatus && matchesKategori;
            });
        }

        // Render table with users
        function renderTable() {
            const filteredUsers = getFilteredUsers();

            console.log("Filter", filteredUsers)
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
            
            // Clear table body
            userTableBody.innerHTML = '';
            
            // Add rows to table
            paginatedUsers.forEach((user, index) => {
                const rowNumber = startIndex + index + 1;
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${rowNumber}.</td>
                    <td>${user.customerID}</td>
                    <td>${user.nama}</td>
                    <td>${user.kategori}</td>
                    <td>${user.kelas}</td>
                    <td><span class="status-badge ${user.status === 'Aktif' ? 'status-aktif' : 'status-nonaktif'}">${user.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" data-id="${user.customerID}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                    </td>
                `;
                
                userTableBody.appendChild(row);
            });
            
            // Update pagination info
            const totalUsers = filteredUsers.length;
            const start = totalUsers > 0 ? startIndex + 1 : 0;
            const end = Math.min(endIndex, totalUsers);
            
            paginationInfo.textContent = `Menampilkan ${start} sampai ${end} dari ${totalUsers} data`;
            
            // Render pagination buttons
            renderPagination(totalUsers);
            
            // Add event listeners to action buttons
            addActionButtonListeners();
        }

        // Render pagination buttons
        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            paginationContainer.innerHTML = '';
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.className = 'pagination-btn';
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });
            paginationContainer.appendChild(prevButton);
            
            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageButton.textContent = i;
                pageButton.addEventListener('click', function() {
                    currentPage = i;
                    renderTable();
                });
                paginationContainer.appendChild(pageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.className = 'pagination-btn';
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });
            paginationContainer.appendChild(nextButton);
        }

        // Add event listeners to action buttons in table
        function addActionButtonListeners() {
            // Edit buttons
            const editButtons = document.querySelectorAll('.btn-edit');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    console.log("user", userId);
                    editUser(userId);
                });
            });
        }

        // Open modal for adding or editing user
        function openModal(user = null) {
            if (user) {
                // Edit mode
                modalTitle.textContent = 'Edit Akun';
                document.getElementById('modal-id').value = user.customerID;
                document.getElementById('modal-nama').value = user.nama;
                document.getElementById('modal-kategori').value = user.kategori;
                document.getElementById('modal-kelas').value = user.kelas;
                document.getElementById('modal-status').value = user.status;
                currentEditId = user.id;
            } else {
                // Add mode
                modalTitle.textContent = 'Tambah Akun Baru';
                document.getElementById('modal-id').value = '';
                document.getElementById('modal-nama').value = '';
                document.getElementById('modal-kategori').value = '';
                document.getElementById('modal-kelas').value = '';
                document.getElementById('modal-status').value = 'Aktif';
                currentEditId = null;
            }
            
            userModal.style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            userModal.style.display = 'none';
            userForm.reset();
            currentEditId = null;
        }

        // Save user (add or edit)
        async function saveUser() {
            const customerID = document.getElementById('modal-id').value;
            const nama = document.getElementById('modal-nama').value;
            const kategori = document.getElementById('modal-kategori').value;
            const kelas = document.getElementById('modal-kelas').value;
            const status = document.getElementById('modal-status').value;

            const userIndex = users.findIndex(user => user.customerID == customerID);
            if (userIndex !== -1) {
                // EDIT
                let akunData = {
                    customerID: customerID,
                    nama: nama,
                    kategori: kategori, 
                    kelas: kelas,
                    status: status,
                };

                console.log('data', JSON.stringify(akunData));

                try {
					let response = await fetch('http://localhost:3000/customer', 
					{
						method: 'PATCH',
						headers: {
							'Access-Control-Allow-Headers' : 'Content-Type',
              				'Access-Control-Allow-Origin': '*',
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(akunData)
					});
					console.log('response', response);

					let result = await response.json();
					console.log('result', result);

					// 200 Success
					if (response.status == 200) {
						alert(`Akun ${customerID} berhasil diperbarui!`);
					} else {
					}
		  		} catch (error) {
					console.error('Error during save:', error);
        			alert('An error occurred. Please try again later.');
		  		}
            } else {
                // ADD
                let akunData = {
                    nama: nama,
                    kategori: kategori, 
                    kelas: kelas,
                };

                console.log('data', JSON.stringify(akunData));

                try {
					let response = await fetch('http://localhost:3000/customer', 
					{
						method: 'POST',
						headers: {
							'Access-Control-Allow-Headers' : 'Content-Type',
              				'Access-Control-Allow-Origin': '*',
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(akunData)
					});
					console.log('response', response);

					let result = await response.json();
					console.log('result', result);

					// 200 Success
					if (response.status == 200) {
						// Show success message
                        alert(`Akun berhasil disimpan!`);
					} else {
					}
		  		} catch (error) {
					console.error('Error during save:', error);
        			alert('An error occurred. Please try again later.');
		  		}
            }
            
            // if (currentEditId) {
            //     // Edit existing user
            //     // const userIndex = users.findIndex(user => user.customerID === currentEditId);
            //     // if (userIndex !== -1) {
            //     //     users[userIndex] = { customerID, nama, kategori, kelas, status };
            //     // }
            // } else {
            //     // // Check if ID already exists
            //     // if (users.some(user => user.customerID === customerID)) {
            //     //     alert('ID Customer sudah ada! Silakan gunakan ID yang berbeda.');
            //     //     return;
            //     // }

            //     // Add new user
            //     // users.push({ customerID, nama, kategori, kelas, status });
            // }
            
            // Re-render table and close modal
            fetchData();
            // renderTable();
            closeModal();
            
            // // Show success message
            // alert(`Akun ${currentEditId ? 'berhasil diperbarui' : 'berhasil disimpan'}!`);
        }

        // Edit user
        function editUser(userId) {
            const user = users.find(user => user.customerID == userId);
            if (user) {
                openModal(user);
            }
        }

        // Fungsi untuk menampilkan modal logout
        function showLogoutModal() {
            logoutModal.classList.add('show');
            modalOverlay.classList.add('show');
            // Blokir scroll body saat modal terbuka
            document.body.style.overflow = 'hidden';
        }

        // Fungsi untuk menyembunyikan modal logout
        function hideLogoutModal() {
            logoutModal.classList.remove('show');
            modalOverlay.classList.remove('show');
            // Kembalikan scroll body
            document.body.style.overflow = 'auto';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Add click event listener to logo container for dashboard navigation
            if (logoContainer) {
                logoContainer.addEventListener('click', function() {
                    window.location.href = 'dashboard.html';
                });
            }

            // Handle click on all menu items
            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    // Skip if this is the Laporan menu
                    if (this.id === 'laporan-menu') {
                        e.preventDefault();
                        return;
                    }
                    
                    // Remove active class from ALL menu items
                    menuItems.forEach(i => {
                        i.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // If clicking on a submenu item, keep the submenu open
                    if (this.closest('.submenu')) {
                        // Ensure the parent submenu is open
                        const parentSubmenu = this.closest('.submenu');
                        const parentHasSubmenu = this.closest('.has-submenu');
                        
                        if (parentSubmenu && !parentSubmenu.classList.contains('show')) {
                            parentSubmenu.classList.add('show');
                            if (parentHasSubmenu) {
                                parentHasSubmenu.classList.add('active');
                            }
                        }
                    } else {
                        // If clicking on a non-submenu item, close all submenus
                        const allSubmenus = document.querySelectorAll('.submenu.show');
                        allSubmenus.forEach(submenu => {
                            submenu.classList.remove('show');
                            const parentHasSubmenu = submenu.closest('.has-submenu');
                            if (parentHasSubmenu) {
                                parentHasSubmenu.classList.remove('active');
                            }
                        });
                    }
                });
            });

            // Handle Laporan menu click (toggle submenu)
            if (laporanMenu) {
                laporanMenu.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Toggle submenu visibility
                    if (laporanSubmenu) {
                        laporanSubmenu.classList.toggle('show');
                    }
                    if (hasSubmenu) {
                        hasSubmenu.classList.toggle('active');
                    }
                    
                    // Close other submenus if any
                    const otherSubmenus = document.querySelectorAll('.submenu.show');
                    otherSubmenus.forEach(submenu => {
                        if (submenu !== laporanSubmenu) {
                            submenu.classList.remove('show');
                            const parentHasSubmenu = submenu.closest('.has-submenu');
                            if (parentHasSubmenu) {
                                parentHasSubmenu.classList.remove('active');
                            }
                        }
                    });
                });
            }

            logoutContainer.addEventListener('click', function(event) {
                event.preventDefault();

                showLogoutModal();
            });

            // Event listener untuk tombol cancel logout
            cancelLogoutBtn.addEventListener('click', function() {
                hideLogoutModal();
            });
            
            // Event listener untuk tombol confirm logout
            confirmLogoutBtn.addEventListener('click', function() {
                localStorage.clear();
                window.location.replace('./login.html');
            });
            
            // Event listener untuk overlay modal
            modalOverlay.addEventListener('click', function() {
                hideLogoutModal();
            });

            // Close submenu when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.has-submenu') && !e.target.closest('.submenu')) {
                    if (laporanSubmenu) {
                        laporanSubmenu.classList.remove('show');
                    }
                    if (hasSubmenu) {
                        hasSubmenu.classList.remove('active');
                    }
                }
            });

            // Search input
            searchInput.addEventListener('input', function() {
                currentPage = 1;
                renderTable();
            });
            
            // Filter select
            statusFilter.addEventListener('change', function() {
                currentPage = 1;
                renderTable();
            });
            
            kategoriFilter.addEventListener('change', function() {
                currentPage = 1;
                renderTable();
            });
            
            // Add user button
            btnAddUser.addEventListener('click', function() {
                openModal();
            });
            
            // Cancel button in modal
            btnCancel.addEventListener('click', function() {
                closeModal();
            });
            
            // Save button in modal (form submit)
            userForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveUser();
            });
            
            // Close modal when clicking outside
            userModal.addEventListener('click', function(e) {
                if (e.target === userModal) {
                    closeModal();
                }
            });
        }
    </script>
</body>
</html>