<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Jenis Sampah - Bank Sampah</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-container" id="logo-container">
            <div class="logo-wrapper">
                <img src="./img/logo_bank_sampah.jpeg" alt="Logo Bank Sampah" class="logo">
            </div>
            <div class="app-title">Bank Sampah</div>
        </div>
        
        <ul class="menu">
            <li class="menu-section">Transaksi</li>
            <li><a href="transaksi_input.html" class="menu-item"><i class="fas fa-sign-in-alt"></i> <span>Transaksi Input</span></a></li>
            <li><a href="transaksi_output.html" class="menu-item"><i class="fas fa-sign-out-alt"></i> <span>Transaksi Output</span></a></li>
            
            <li class="menu-section">Kelola Data</li>
            <li><a href="kelola_akun.html" class="menu-item"><i class="fas fa-users"></i> <span>Kelola Akun</span></a></li>
            <li><a href="kelola_pengepul.html" class="menu-item"><i class="fas fa-truck"></i> <span>Kelola Pengepul</span></a></li>
            <li><a href="#" class="menu-item active"><i class="fas fa-cog"></i> <span>Kelola Jenis Sampah</span></a></li>
            
            <li class="menu-section">Laporan</li>
            <li class="has-submenu">
                <a href="#" class="menu-item" id="laporan-menu">
                    <i class="fas fa-chart-bar"></i> 
                    <span>Laporan</span>
                    <i class="fas fa-chevron-down dropdown-icon"></i>
                </a>
                <ul class="submenu" id="laporan-submenu">
                    <li><a href="laporan_transaksi.html" class="menu-item"><i class="fas fa-file-invoice-dollar"></i> <span>Laporan Transaksi</span></a></li>
                    <li><a href="laporan_stok.html" class="menu-item"><i class="fas fa-boxes"></i> <span>Laporan Stok</span></a></li>
                </ul>
            </li>
            
            <li class="menu-section">Akun</li>
            <li><a href="#" class="menu-item" id="logout"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <h1 class="page-title">Kelola Jenis Sampah</h1>
            <div class="user-info">
                <div class="user-avatar">AD</div>
                <div class="user-text">
                    <div class="user-greeting" id="user">Hi</div>
                    <div class="user-role">Administrator</div>
                </div>
            </div>
        </div>
        
        <!-- Content Container -->
        <div class="content-container">
            <!-- Search and Filter Section -->
            <div class="search-filter-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Cari jenis sampah...">
                </div>
                
                <div class="filter-container">
                    <select class="filter-select" id="status-filter">
                        <option value="">Semua Status</option>
                        <option value="aktif">Aktif</option>
                        <option value="nonaktif">Non Aktif</option>
                    </select>
                    
                    <button class="btn-add" id="btn-add-sampah">
                        <i class="fas fa-plus"></i> Tambah Jenis Sampah
                    </button>
                </div>
            </div>
            
            <!-- Table Container -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>ID Jenis Sampah</th>
                            <th>Jenis Sampah</th>
                            <th>Stok (Kg)</th>
                            <th>Harga/Kg</th>
                            <th>Status</th>
                            <th>ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="sampah-table-body">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-container">
                <div class="pagination-info" id="pagination-info">
                    Menampilkan 1 sampai 4 dari 4 data
                </div>
                
                <div class="pagination" id="pagination">
                    <!-- Pagination buttons will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Jenis Sampah -->
    <div class="modal" id="sampah-modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modal-title">Tambah Jenis Sampah</h2>
            
            <form id="sampah-form">
                <div style="margin-bottom: 15px;">
                    <label class="modal-label">ID Jenis Sampah</label>
                    <input type="text" id="modal-id" class="modal-input" disabled>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label class="modal-label">Jenis Sampah</label>
                    <input type="text" id="modal-nama" class="modal-input" required>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label class="modal-label">Stok (kg)</label>
                    <input type="number" id="modal-stok" min="0" step="0.1" class="modal-input" required>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label class="modal-label">Harga per Kg</label>
                    <div style="display: flex; align-items: center;">
                        <span style="padding: 10px; background-color: #f8f9fa; border: 1px solid var(--border-color); border-right: none; border-radius: 5px 0 0 5px;">Rp</span>
                        <input type="number" id="modal-harga" min="0" step="100" class="modal-input" required>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label class="modal-label">Status</label>
                    <select id="modal-status" class="modal-input" required>
                        <option value="Aktif">Aktif</option>
                        <option value="Nonaktif">Nonaktif</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" id="btn-cancel" class="modal-btn modal-btn-cancel">Batal</button>
                    <button type="submit" id="btn-save" class="modal-btn modal-btn-save">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Overlay untuk modal (DI BAWAH MODAL) -->
    <div class="modal-overlay" id="modal-overlay"></div>
    
    <!-- Modal Konfirmasi Logout (DI ATAS OVERLAY) -->
    <div class="logout-modal" id="logout-modal">
        <div class="modal-icon">
            <img src="./img/icon_logout.png" width="100" height="100">
        </div>
        <p class="modal-message">Apakah Anda yakin ingin keluar?</p>
        <div class="modal-buttons">
            <button class="modal-btn-logout cancel" id="cancel-logout">Tidak</button>
            <button class="modal-btn-logout confirm" id="confirm-logout">Ya</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const logoContainer = document.getElementById('logo-container');
        const menuItems = document.querySelectorAll('.menu-item');
        const laporanMenu = document.getElementById('laporan-menu');
        const laporanSubmenu = document.getElementById('laporan-submenu');
        const hasSubmenu = laporanMenu ? laporanMenu.closest('.has-submenu') : null;
        const logoutContainer = document.getElementById('logout');
        const logoutModal = document.getElementById('logout-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const cancelLogoutBtn = document.getElementById('cancel-logout');
        const confirmLogoutBtn = document.getElementById('confirm-logout');
        const sampahTableBody = document.getElementById('sampah-table-body');
        const paginationInfo = document.getElementById('pagination-info');
        const paginationContainer = document.getElementById('pagination');
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        const btnAddSampah = document.getElementById('btn-add-sampah');
        const sampahModal = document.getElementById('sampah-modal');
        const modalTitle = document.getElementById('modal-title');
        const sampahForm = document.getElementById('sampah-form');
        const btnCancel = document.getElementById('btn-cancel');
        const btnSave = document.getElementById('btn-save');

        // State
        let isLogin = false;
        let storedLoginData;
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentEditId = null;
        let sampahData = [];
        

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginData();

            if (isLogin) {
                // Fetch data from server when page loads
                fetchData();
                
                // Setup event listeners
                setupEventListeners();
            }
        });

        function checkLoginData() {
            // Retrieve the value using the same key 'loginData'
            storedLoginData = JSON.parse(localStorage.getItem('loginData'));

            if (storedLoginData == null) {
                window.location.replace('./login.html');
            } else {
                isLogin = true;
                document.getElementById("user").textContent = `Hi, ${storedLoginData.nama}`;
            }
        }

        async function fetchData() {
            try {
                const response = await fetch('http://localhost:3000/sampah');
                console.log('response', response);

				const result = await response.json();
				console.log('result', result);

                sampahData = result.data || [];
                console.log('data', sampahData);

                renderTable();
            } catch (error) {
                console.error('Error during fetch data:', error);
        		alert('An error occurred. Please try again later.');
            }
        }

        // Filter sampah based on search and filters
        function getFilteredSampah() {
            // Apply search filter
            const searchTerm = searchInput.value.toLowerCase();
            
            // Apply status filter
            const statusFilterValue = statusFilter.value;

            return sampahData.filter(sampah => {
                const matchesSearch = sampah.namaJenis.toLowerCase().includes(searchTerm) || 
                              String(sampah.jenisSampahID).includes(searchTerm);
                const matchesStatus = statusFilterValue === "" || sampah.status.toLowerCase() === statusFilterValue;
        
                return matchesSearch && matchesStatus;
            });
        }

        // Render table with sampah data
        function renderTable() {
            const filteredSampah = getFilteredSampah();
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedSampah = filteredSampah.slice(startIndex, endIndex);
            
            // Clear table body
            sampahTableBody.innerHTML = '';
            
            // Add rows to table
            paginatedSampah.forEach((sampah, index) => {
                const rowNumber = startIndex + index + 1;
                const row = document.createElement('tr');
                
                // Hanya tombol Edit, tanpa tombol Hapus
                row.innerHTML = `
                    <td>${rowNumber}.</td>
                    <td>${sampah.jenisSampahID}</td>
                    <td>${sampah.namaJenis}</td>
                    <!--<td>${formatStok(sampah.stok, sampah.satuan)}</td>-->
                    <td>${sampah.stok}</td>
                    <td>${formatRupiah(sampah.hargaPerKg)}</td>
                    <td><span class="status-badge ${sampah.status === 'Aktif' ? 'status-aktif' : 'status-nonaktif'}">${sampah.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" data-id="${sampah.jenisSampahID}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                    </td>
                `;
                
                sampahTableBody.appendChild(row);
            });
            
            // Update pagination info
            const totalSampah = filteredSampah.length;
            const start = totalSampah > 0 ? startIndex + 1 : 0;
            const end = Math.min(endIndex, totalSampah);
            
            paginationInfo.textContent = `Menampilkan ${start} sampai ${end} dari ${totalSampah} data`;
            
            // Render pagination buttons
            renderPagination(totalSampah);
            
            // Add event listeners to action buttons
            addActionButtonListeners();
        }

        // Render pagination buttons
        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            paginationContainer.innerHTML = '';
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.className = 'pagination-btn';
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });
            paginationContainer.appendChild(prevButton);
            
            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageButton.textContent = i;
                pageButton.addEventListener('click', function() {
                    currentPage = i;
                    renderTable();
                });
                paginationContainer.appendChild(pageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.className = 'pagination-btn';
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });
            paginationContainer.appendChild(nextButton);
        }

        // Add event listeners to action buttons in table
        function addActionButtonListeners() {
            // Edit buttons
            const editButtons = document.querySelectorAll('.btn-edit');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const sampahId = this.getAttribute('data-id');
                    editSampah(sampahId);
                });
            });
        }

        // Open modal for adding or editing sampah
        function openModal(sampah = null) {
            if (sampah) {
                // Edit mode
                modalTitle.textContent = 'Edit Jenis Sampah';
                document.getElementById('modal-id').value = sampah.jenisSampahID;
                document.getElementById('modal-nama').value = sampah.namaJenis;
                document.getElementById('modal-stok').value = sampah.stok;
                document.getElementById('modal-harga').value = sampah.hargaPerKg;
                document.getElementById('modal-status').value = sampah.status;
                currentEditId = sampah.id;
                
                // Make ID field readonly when editing
                document.getElementById('modal-id').readOnly = true;
            } else {
                // Add mode
                modalTitle.textContent = 'Tambah Jenis Sampah';
                document.getElementById('modal-id').value = '';
                document.getElementById('modal-nama').value = '';
                document.getElementById('modal-stok').value = '';
                document.getElementById('modal-harga').value = '';
                document.getElementById('modal-status').value = 'Aktif';
                currentEditId = null;
                
                // Make ID field editable when adding
                document.getElementById('modal-id').readOnly = false;
            }
            
            sampahModal.style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            sampahModal.style.display = 'none';
            sampahForm.reset();
            currentEditId = null;
        }

        // Save sampah (add or edit)
        async function saveSampah() {
            const jenisSampahID = document.getElementById('modal-id').value;
            const nama = document.getElementById('modal-nama').value;
            const stok = parseFloat(document.getElementById('modal-stok').value);
            const harga = parseInt(document.getElementById('modal-harga').value);
            const status = document.getElementById('modal-status').value;
            
            // Validate inputs
            // if (!id || !nama || isNaN(stok) || isNaN(harga) || stok < 0 || harga < 0) {
            //     alert('Harap isi semua field dengan data yang valid!');
            //     return;
            // }

            const sampahIndex = sampahData.findIndex(sampah => sampah.jenisSampahID == jenisSampahID);
            if (sampahIndex !== -1) {
                // EDIT
                let payloadData = {
                    jenisSampahID: jenisSampahID,
                    namaJenis: nama,
                    hargaPerKg: harga, 
                    stok: stok,
                    status: status,
                };

                console.log('data', JSON.stringify(payloadData));

                try {
					let response = await fetch('http://localhost:3000/sampah', 
					{
						method: 'PATCH',
						headers: {
							'Access-Control-Allow-Headers' : 'Content-Type',
              				'Access-Control-Allow-Origin': '*',
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(payloadData)
					});
					console.log('response', response);

					let result = await response.json();
					console.log('result', result);

					// 200 Success
					if (response.status == 200) {
						alert(`Sampah ${jenisSampahID} berhasil diperbarui!`);
					} else {
					}
		  		} catch (error) {
					console.error('Error during save:', error);
        			alert('An error occurred. Please try again later.');
		  		}
            } else {
                // ADD
                let payloadData = {
                    namaJenis: nama,
                    hargaPerKg: harga, 
                    stok: stok,
                };

                console.log('data', JSON.stringify(payloadData));

                try {
					let response = await fetch('http://localhost:3000/sampah', 
					{
						method: 'POST',
						headers: {
							'Access-Control-Allow-Headers' : 'Content-Type',
              				'Access-Control-Allow-Origin': '*',
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(payloadData)
					});
					console.log('response', response);

					let result = await response.json();
					console.log('result', result);

					// 200 Success
					if (response.status == 200) {
						// Show success message
                        alert(`Sampah berhasil disimpan!`);
					} else {
					}
		  		} catch (error) {
					console.error('Error during save:', error);
        			alert('An error occurred. Please try again later.');
		  		}
            }

            
            // Re-render table and close modal
            fetchData();
            // renderTable();
            closeModal();
            
            // Show success message
            // alert(`Jenis sampah ${currentEditId ? 'berhasil diperbarui' : 'berhasil ditambahkan'}!`);
        }

        // Edit sampah
        function editSampah(sampahId) {
            const sampah = sampahData.find(sampah => sampah.jenisSampahID == sampahId);
            if (sampah) {
                openModal(sampah);
            }
        }

        // Fungsi untuk menampilkan modal logout
        function showLogoutModal() {
            logoutModal.classList.add('show');
            modalOverlay.classList.add('show');
            // Blokir scroll body saat modal terbuka
            document.body.style.overflow = 'hidden';
        }

        // Fungsi untuk menyembunyikan modal logout
        function hideLogoutModal() {
            logoutModal.classList.remove('show');
            modalOverlay.classList.remove('show');
            // Kembalikan scroll body
            document.body.style.overflow = 'auto';
        }

        // Format angka menjadi format Rupiah
        function formatRupiah(angka) {
            return 'Rp ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Format stok dengan satuan
        function formatStok(stok, satuan) {
            return stok + ' ' + satuan;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Add click event listener to logo container for dashboard navigation
            if (logoContainer) {
                logoContainer.addEventListener('click', function() {
                    window.location.href = 'dashboard.html';
                });
            }

            // Handle click on all menu items
            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    // Skip if this is the Laporan menu
                    if (this.id === 'laporan-menu') {
                        e.preventDefault();
                        return;
                    }
                    
                    // Remove active class from ALL menu items
                    menuItems.forEach(i => {
                        i.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // If clicking on a submenu item, keep the submenu open
                    if (this.closest('.submenu')) {
                        // Ensure the parent submenu is open
                        const parentSubmenu = this.closest('.submenu');
                        const parentHasSubmenu = this.closest('.has-submenu');
                        
                        if (parentSubmenu && !parentSubmenu.classList.contains('show')) {
                            parentSubmenu.classList.add('show');
                            if (parentHasSubmenu) {
                                parentHasSubmenu.classList.add('active');
                            }
                        }
                    } else {
                        // If clicking on a non-submenu item, close all submenus
                        const allSubmenus = document.querySelectorAll('.submenu.show');
                        allSubmenus.forEach(submenu => {
                            submenu.classList.remove('show');
                            const parentHasSubmenu = submenu.closest('.has-submenu');
                            if (parentHasSubmenu) {
                                parentHasSubmenu.classList.remove('active');
                            }
                        });
                    }
                });
            });

            // Handle Laporan menu click (toggle submenu)
            if (laporanMenu) {
                laporanMenu.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Toggle submenu visibility
                    if (laporanSubmenu) {
                        laporanSubmenu.classList.toggle('show');
                    }
                    if (hasSubmenu) {
                        hasSubmenu.classList.toggle('active');
                    }
                    
                    // Close other submenus if any
                    const otherSubmenus = document.querySelectorAll('.submenu.show');
                    otherSubmenus.forEach(submenu => {
                        if (submenu !== laporanSubmenu) {
                            submenu.classList.remove('show');
                            const parentHasSubmenu = submenu.closest('.has-submenu');
                            if (parentHasSubmenu) {
                                parentHasSubmenu.classList.remove('active');
                            }
                        }
                    });
                });
            }

            logoutContainer.addEventListener('click', function(event) {
                event.preventDefault();

                showLogoutModal();
            });

            // Event listener untuk tombol cancel logout
            cancelLogoutBtn.addEventListener('click', function() {
                hideLogoutModal();
            });
            
            // Event listener untuk tombol confirm logout
            confirmLogoutBtn.addEventListener('click', function() {
                localStorage.clear();
                window.location.replace('./login.html');
            });
            
            // Event listener untuk overlay modal
            modalOverlay.addEventListener('click', function() {
                hideLogoutModal();
            });

            // Close submenu when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.has-submenu') && !e.target.closest('.submenu')) {
                    if (laporanSubmenu) {
                        laporanSubmenu.classList.remove('show');
                    }
                    if (hasSubmenu) {
                        hasSubmenu.classList.remove('active');
                    }
                }
            });

            // Search input
            searchInput.addEventListener('input', function() {
                currentPage = 1;
                renderTable();
            });
            
            // Filter select
            statusFilter.addEventListener('change', function() {
                currentPage = 1;
                renderTable();
            });
            
            // Add sampah button
            btnAddSampah.addEventListener('click', function() {
                openModal();
            });
            
            // Cancel button in modal
            btnCancel.addEventListener('click', function() {
                closeModal();
            });
            
            // Save button in modal (form submit)
            sampahForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveSampah();
            });
            
            // Close modal when clicking outside
            sampahModal.addEventListener('click', function(e) {
                if (e.target === sampahModal) {
                    closeModal();
                }
            });
        }
    </script>
</body>
</html>